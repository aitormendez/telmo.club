---
import SiteLayout from "../../layouts/SiteLayout.astro";
import { getCollection } from "astro:content";
import { Image } from "astro:assets";

const thumbGlob = import.meta.glob(
  "../../content/projects/**/**/*.{jpg,jpeg,png,webp,gif}",
  { eager: true, import: "default" }
);

const projects = (await getCollection("projects"))
  .filter((p) => p.data.title)
  .sort((a, b) => {
    const da = a.data.date ? a.data.date.getTime() : 0;
    const db = b.data.date ? b.data.date.getTime() : 0;
    return db - da;
  });

const entrySlug = (entry) =>
  entry.id.replace(/^projects\//, "").split("/")[0] ||
  entry.slug.split("/").pop() ||
  entry.slug;

const entryFolder = (entry) => {
  const parts = entry.id.replace(/^projects\//, "").split("/");
  parts.pop();
  return parts.join("/");
};

const normalizeThumb = (entry: any) => {
  const thumb = entry.data.thumbnail;
  if (!thumb) return { meta: undefined, url: undefined };

  if (typeof thumb === "object" && thumb !== null && "src" in thumb) {
    return { meta: thumb as any, url: (thumb as any).src as string };
  }

  if (typeof thumb === "string") {
    if (thumb.startsWith("./")) {
      const key = `../../content/projects/${entryFolder(entry)}/${thumb.slice(2)}`;
      const found = thumbGlob[key];
      if (found) {
        const url =
          typeof found === "string"
            ? found
            : (found as any).src ?? (found as any).default ?? (found as any);
        return { meta: undefined, url };
      }
      return { meta: undefined, url: undefined };
    }
    if (thumb.startsWith("/")) return { meta: undefined, url: thumb };
    try {
      return { meta: undefined, url: Astro.resolve(thumb) };
    } catch {
      return { meta: undefined, url: undefined };
    }
  }

  return { meta: undefined, url: undefined };
};
---

<SiteLayout title="proyectos | telmo">
  <main class="pt-6 pb-12">
    <div
      class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-0 w-full"
    >
      {
        projects.map((entry) => {
          const { meta, url } = normalizeThumb(entry);
          const href = `/projects/${entrySlug(entry)}/`;
          return (
            <article class="project-tile">
              <a href={href} class="block w-full h-full">
                {meta ? (
                  <Image
                    src={meta}
                    alt={entry.data.title}
                    loading="lazy"
                    class="thumb"
                  />
                ) : url ? (
                  <img
                    src={url}
                    alt={entry.data.title}
                    loading="lazy"
                    class="thumb"
                  />
                ) : (
                  <div class="thumb thumb-placeholder" />
                )}
                <div class="title">{entry.data.title}</div>
              </a>
            </article>
          );
        })
      }
    </div>
  </main>

  <style>
    .project-tile {
      display: flex;
      flex-direction: column;
      border: 1px solid transparent;
      transition: border-color 150ms ease, background-color 150ms ease;
    }
    .project-tile:hover {
      border-color: #ddd;
      background: #fafafa;
    }
    .thumb {
      width: 100%;
      aspect-ratio: 4 / 3;
      object-fit: cover;
      display: block;
    }
    .thumb-placeholder {
      background: #f4f4f4;
    }
    .title {
      padding: 10px 12px 14px;
      font-size: 1.5rem;
      color: #0ea5e9;
      line-height: 1.3;
      transition: color 150ms ease;
    }
    .project-tile:hover .title {
      color: #000;
    }
  </style>
</SiteLayout>
