---
import SiteLayout from "../../layouts/SiteLayout.astro";
import { getCollection } from "astro:content";

const dob = new Date("2013-02-16");

const dialogos = await getCollection("dialogos");

const rendered = await Promise.all(
  dialogos.map(async (entry) => {
    const { Content, frontmatter } = await entry.render();
    const date = new Date(entry.data.date);
    return { entry, Content, frontmatter, date };
  })
);

rendered.sort((a, b) => a.date.getTime() - b.date.getTime());

type Group = {
  year: number;
  month: number;
  monthName: string;
  entries: typeof rendered;
};

const groups: Group[] = [];

for (const item of rendered) {
  const year = item.date.getFullYear();
  const month = item.date.getMonth();
  const monthName = item.date.toLocaleString("es-ES", { month: "long" });
  const key = `${year}-${month}`;
  let group = groups.find((g) => `${g.year}-${g.month}` === key);
  if (!group) {
    group = { year, month, monthName, entries: [] };
    groups.push(group);
  }
  group.entries.push(item);
}

const diffAge = (date: Date) => {
  let months =
    (date.getFullYear() - dob.getFullYear()) * 12 +
    (date.getMonth() - dob.getMonth());
  if (date.getDate() < dob.getDate()) months -= 1;
  const years = Math.floor(months / 12);
  const remMonths = months - years * 12;
  return { years, months: remMonths };
};
---

<SiteLayout title="Conversaciones | telmo">
  <main class="w-full py-10">
    {
      groups.map((group, idx) => {
        const prevYear = groups[idx - 1]?.year;
        const showYear = prevYear !== group.year;
        const ageLabel = diffAge(group.entries[0].date);
        return (
          <section class="w-full">
            <div class="mx-auto">
              {showYear && (
                <div class="dash-line mb-2" style="--dash-gap: 1rem">
                  <div class="px-5 sm:px-6">
                    <div class="text-5xl">{group.year}</div>
                  </div>
                </div>
              )}

              <div class="dash-line mb-10" style="--dash-gap: 1rem">
                <div class="text-3xl px-5 sm:px-6">
                  <div>{group.monthName}</div>
                  <div>
                    telmo tiene {ageLabel.years} a√±os y {ageLabel.months} meses
                  </div>
                </div>
              </div>

              <div>
                {group.entries.map((item, entryIdx) => {
                  const isLast = entryIdx === group.entries.length - 1;
                  return (
                    <article
                      class={`dash-line ${isLast ? "mb-2" : "mb-10"}`}
                      style="--dash-gap: 3rem"
                    >
                      <h3 class="mb-4 px-5 sm:px-6 text-xl sm:absolute">
                        <a href={`/${item.entry.slug}`} class="">
                          {item.entry.data.title}
                        </a>
                      </h3>
                      <div class="max-w-3xl mx-auto px-5 sm:px-6">
                        <div class="text-xl max-w-none">
                          <item.Content />
                        </div>
                      </div>
                    </article>
                  );
                })}
              </div>
            </div>
          </section>
        );
      })
    }
  </main>
</SiteLayout>
