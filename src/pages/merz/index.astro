---
import SiteLayout from "../../layouts/SiteLayout.astro";
import { getCollection } from "astro:content";
import { Image } from "astro:assets";

const thumbGlob = import.meta.glob(
  "../../content/merz/**/**/*.{jpg,jpeg,png,webp,gif}",
  { eager: true, import: "default" }
);

const merzEntries = (await getCollection("merz")).sort((a, b) => {
  const aDate = (a.data.date as Date | undefined)?.getTime?.() ?? 0;
  const bDate = (b.data.date as Date | undefined)?.getTime?.() ?? 0;
  return bDate - aDate;
});

const entrySlug = (entry) =>
  entry.id.replace(/^merz\//, "").split("/")[0] ||
  entry.slug.split("/").pop() ||
  entry.slug;

const entryFolder = (entry) => {
  const parts = entry.id.replace(/^merz\//, "").split("/");
  parts.pop(); // remove filename
  return parts.join("/");
};

const tagSet = new Set<string>();
for (const entry of merzEntries) {
  (entry.data.tags || []).forEach((tag) => tagSet.add(tag));
}
const tags = Array.from(tagSet).sort((a, b) =>
  a.localeCompare(b, "es", { sensitivity: "base" })
);

const resolveThumb = (entry) => {
  const thumb = entry.data.thumbnail;
  if (!thumb) return { meta: undefined, url: undefined };

  if (typeof thumb === "object" && thumb !== null && "src" in thumb) {
    return { meta: thumb as any, url: (thumb as any).src as string };
  }

  if (typeof thumb === "string") {
    if (thumb.startsWith("./")) {
      const key = `../../content/merz/${entryFolder(entry)}/${thumb.slice(2)}`;
      const found = thumbGlob[key];
      if (found) {
        const url =
          typeof found === "string"
            ? found
            : (found as any).src ?? (found as any).default ?? (found as any);
        return { meta: undefined, url };
      }
      return { meta: undefined, url: undefined };
    }
    if (thumb.startsWith("/")) return { meta: undefined, url: thumb };
    try {
      return { meta: undefined, url: Astro.resolve(thumb) };
    } catch {
      return { meta: undefined, url: undefined };
    }
  }

  return { meta: undefined, url: undefined };
};
---

<SiteLayout title="merz | telmo">
  <main class="pt-6 pb-12">
    <div
      class="mb-6 flex flex-wrap text-sky-700 text-sm tracking-wide px-5 sm:px-6"
    >
      <button
        class="filter-btn active uppercase mr-2"
        data-filter="all"
        type="button">mostrar todo</button
      >
      {
        tags.map((tag) => (
          <button class="filter-btn mr-2" data-filter={tag} type="button">
            {tag}
          </button>
        ))
      }
    </div>

    <div
      class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-0 w-full"
    >
      {
        merzEntries.map((entry) => {
          const { meta, url } = resolveThumb(entry);
          const tagList = (entry.data.tags || []).join("|");
          const slug = entrySlug(entry);
          const href = `/merz/${slug}/`;
          return (
            <article
              class="tile"
              data-tags={tagList}
              aria-label={entry.data.title}
            >
              {meta ? (
                <a href={href} class="block w-full h-full">
                  <Image
                    src={meta}
                    alt={entry.data.title}
                    loading="lazy"
                    class="block w-full h-full object-cover"
                  />
                  <span class="tile-label">{entry.data.title}</span>
                </a>
              ) : url ? (
                <a href={href} class="block w-full h-full">
                  <img
                    src={url}
                    alt={entry.data.title}
                    loading="lazy"
                    class="block w-full h-full object-cover"
                  />
                  <span class="tile-label">{entry.data.title}</span>
                </a>
              ) : (
                <div class="flex items-center justify-center w-full h-full bg-gray-100">
                  <span class="text-center font-semibold">
                    {entry.data.title}
                  </span>
                </div>
              )}
            </article>
          );
        })
      }
    </div>
  </main>

  <style>
    .filter-btn {
      border: none;
      background: none;
      padding: 0 2px;
      cursor: pointer;
      font-family: var(--font-sans, "dino", sans-serif);
      text-transform: uppercase;
      transition: color 150ms ease;
    }
    .filter-btn:hover {
      color: #0ea5e9;
    }
    .filter-btn.active {
      color: #000;
      text-decoration: none;
      text-underline-offset: 3px;
    }
    .tile {
      position: relative;
      aspect-ratio: 1 / 1;
      overflow: hidden;
      transition:
        opacity 200ms ease,
        transform 200ms ease;
    }
    .tile-label {
      position: absolute;
      top: 12px;
      left: 12px;
      padding: 6px 8px;
      font-size: 1.6rem;
      font-style: italic;
      opacity: 0;
      transition: opacity 500ms ease;
      pointer-events: none;
    }
    .tile:hover .tile-label {
      opacity: 1;
    }
    .tile img {
      transition: opacity 1s ease;
    }
    .tile:hover img {
      opacity: 0.5;
    }
    .tile.exit {
      opacity: 0;
      transform: scale(0.96);
    }
    .tile.enter {
      opacity: 0;
      transform: scale(0.96);
    }
  </style>

  <script>
    const FILTER_ANIM_MS = 200;
    const tiles = Array.from(document.querySelectorAll("[data-tags]"));
    const buttons = Array.from(document.querySelectorAll("[data-filter]"));
    let currentFilter = "all";
    const hideTimers = new WeakMap();

    const parseTags = (el) =>
      (el.dataset.tags || "")
        .split("|")
        .map((t) => t.trim())
        .filter(Boolean);

    function applyFilter(filter) {
      if (filter === currentFilter) return;
      currentFilter = filter;
      buttons.forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.filter === filter);
      });

      tiles.forEach((tile) => {
        const tags = parseTags(tile);
        const matches = filter === "all" || tags.includes(filter);

        if (matches) {
          const pending = hideTimers.get(tile);
          if (pending) {
            clearTimeout(pending);
            hideTimers.delete(tile);
          }
          const wasHidden = tile.hasAttribute("hidden");
          if (wasHidden) {
            tile.classList.add("enter");
            tile.removeAttribute("hidden");
            requestAnimationFrame(() => {
              tile.classList.remove("enter");
            });
          }
        } else {
          tile.classList.add("exit");
          const timer = window.setTimeout(() => {
            tile.setAttribute("hidden", "true");
            tile.classList.remove("exit");
            hideTimers.delete(tile);
          }, FILTER_ANIM_MS);
          hideTimers.set(tile, timer);
        }
      });
    }

    buttons.forEach((btn) => {
      btn.addEventListener("click", () => {
        applyFilter(btn.dataset.filter || "all");
      });
    });
  </script>
</SiteLayout>
