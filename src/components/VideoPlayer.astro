---
import "vidstack/define/media-player.js";
import "vidstack/define/media-outlet.js";
import "vidstack/define/media-community-skin.js";
import "vidstack/styles/defaults.css";
import "vidstack/styles/community-skin/video.css";

interface Props {
  src: string;
  poster?: string;
  title?: string;
}

const { src, poster, title = "VÃ­deo" } = Astro.props as Props;

const isYouTube = /youtu\.?be/.test(src);

// Normalize youtu.be links to embed format
const youtubeEmbed = isYouTube
  ? (() => {
      const idMatch = src.match(/(?:v=|be\/)([A-Za-z0-9_-]{6,})/);
      const id = idMatch?.[1];
      return id ? `https://www.youtube.com/embed/${id}` : src;
    })()
  : null;
---

{isYouTube ? (
  <div class="video-embed">
    <iframe
      src={youtubeEmbed || src}
      title={title}
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
      allowfullscreen
      loading="lazy"
    ></iframe>
  </div>
) : (
  <media-player
    class="video-player"
    title={title}
    src={src}
    poster={poster}
    crossorigin="anonymous"
    playsinline
  >
    <media-outlet></media-outlet>
    <media-community-skin data-video></media-community-skin>
  </media-player>
)}

<style>
  .video-embed {
    position: relative;
    width: 100%;
    padding-top: 56.25%;
    background: #000;
  }
  .video-embed iframe {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    border: 0;
  }

  .video-player {
    width: 100%;
    --media-controls-bg: rgba(0, 0, 0, 0.45);
    --media-controls-color: #fff;
  }

  media-player[aspect-ratio] {
    max-width: none;
  }
</style>
